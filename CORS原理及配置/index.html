<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.1.1"></head>

<body>
  <div id="container">
    
    
      
      
        
      
    
    <div class="bg-lines">
      <div class="bg-lines-item"></div>
      <div class="bg-lines-item"></div>
      <div class="bg-lines-item"></div>
      <div class="bg-lines-item"></div>
      <div class="bg-lines-item"></div>
      <div class="bg-lines-item"></div>
      <div class="bg-lines-item"></div>
      <div class="bg-lines-item"></div>
      <div class="bg-lines-item"></div>
    </div>
    <nav class="nav from-post">
  <div class="bg"></div>
  <a class="nav-title" href="/">
    HEY!HENRY
  </a>
  <ul class="nav-links">
    <li>
      <a class="nav-link bold" href="/archives/">
        All articles
        <span class="nav-link-number">7</span>
      </a>
    </li>
    
      <li>
        <a class="nav-link" href="/tags/React/">
          React
          <span class="nav-link-number">
            2
          </span>
        </a>
      </li>
    
      <li>
        <a class="nav-link" href="/tags/Basic/">
          Basic
          <span class="nav-link-number">
            1
          </span>
        </a>
      </li>
    
      <li>
        <a class="nav-link" href="/tags/Server/">
          Server
          <span class="nav-link-number">
            2
          </span>
        </a>
      </li>
    
      <li>
        <a class="nav-link" href="/tags/Cross-Platform/">
          Cross-Platform
          <span class="nav-link-number">
            2
          </span>
        </a>
      </li>
    
  </ul>
  <a class="leave-btn" href="http://hong-yu.wang" target="_blank" rel="noopener">ABOUT ME</a>
</nav>

<nav class="nav-mobile">
  <div class="top-bar">
    <a class="logo" href="/" ></a>
    <ul class="btns">
      <li class="btn" data-type="tag">
        <p class="text">ARTICLES</p>
        <p class="icon icon-book"></p>
      </li>
    </ul>
  </div>
  <div class="list tag-list">
    <div></div>
    <div class="list-main">
      <ul>
        <li>
          <a class="link" href="/archives/">
            All articles
          </a>
        </li>
        
          <li>
            <a class="link" href="/tags/React/">
              React
            </a>
          </li>
        
          <li>
            <a class="link" href="/tags/Basic/">
              Basic
            </a>
          </li>
        
          <li>
            <a class="link" href="/tags/Server/">
              Server
            </a>
          </li>
        
          <li>
            <a class="link" href="/tags/Cross-Platform/">
              Cross-Platform
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>
    <div class="body from-post">
      
  
    <div class="main">

  

<section class="menu">
  <header class="header">
    <h1 class="title">
      Basic
      <span class="number">1</span>
    </h1>
  </header>
  <section class="list">
    
      <article class="item current">
        <a href="/CORS原理及配置/">
          <p class="item-info">2020-01-03 16:27</p>
          <p class="item-title">CORS原理及配置</p>
        </a>
      </article>
    
  </section>
</section>
  <section class="article">
  <p class="info">2020-01-03 16:27</p>
  <h1 class="title">CORS原理及配置</h1>
  <p class="summary"></p>
  <div class="main-content">
    <h2 id="1-同源策略和跨域"><a href="#1-同源策略和跨域" class="headerlink" title="1 同源策略和跨域"></a>1 同源策略和跨域</h2><h3 id="1-1-同源策略概念"><a href="#1-1-同源策略概念" class="headerlink" title="1.1 同源策略概念"></a>1.1 同源策略概念</h3><p>同源策略（same-origin policy）是浏览器层实现的一种安全机制，非同源资源间的某些行为会受到限制。</p>
<p>“同源”要求资源在三个方面相同：</p>
<ul>
<li>域名</li>
<li>协议</li>
<li>端口号</li>
</ul>
<p>非同源下，受限制行为主要包括：</p>
<ul>
<li>Ajax请求</li>
<li>Cookie、LocalStorage等读取</li>
<li>DOM获取</li>
</ul>
<p>非同源下，不受限制的行为主要包括：</p>
<ul>
<li>页面中的链接、重定向、表单提交</li>
<li>静态资源引入。包括js、css、图片等。</li>
</ul>
<h3 id="1-2-为什么要跨域"><a href="#1-2-为什么要跨域" class="headerlink" title="1.2 为什么要跨域"></a>1.2 为什么要跨域</h3><p>在一个域下通过受同源策略限制的方式请求另一个域下资源时，就要进行跨域处理，最常见的就是js ajax请求，比如以下场景：<br>1、开发测试过程中，FE在本地/前端开发机起的项目，调RD、QA机器上部署的接口<br>2、线上业务调其他域名接口，比如代理商系统（eduagent.baidu.com）调文库（wenku.baidu.com）上传接口</p>
<h3 id="1-3-跨域方式"><a href="#1-3-跨域方式" class="headerlink" title="1.3 跨域方式"></a>1.3 跨域方式</h3><p>跨域的方式有很多，常用在ajax请求中的包括：</p>
<ul>
<li>CORS</li>
<li>JSONP：利用script不受限，向server传函数供server调用并传入数据。</li>
</ul>
<p>其他方式包括：</p>
<ul>
<li>降域：document.domain设置域名范围，比如：b.baidu.com —&gt; baidu.com </li>
<li>postMessage</li>
<li>window.name</li>
</ul>
<h2 id="2-CORS"><a href="#2-CORS" class="headerlink" title="2 CORS"></a>2 CORS</h2><p>CORS全称”跨域资源共享”（Cross-origin resource sharing），在浏览器支持、服务端配置的情况下，允许ajax跨域请求。</p>
<ul>
<li>当页面有跨域请求时，浏览器自动对请求进行额外处理，并发送到服务端；</li>
<li>服务端通过浏览器的预处理，决定是否允许本次跨域请求，并在返回中带上相应的头；</li>
<li>当请求返回时，浏览器通过校验返回头，决定是否继续返回接口数据。<br><img src="http://static.chiyuanyuan.com/P6DtUt.jpg" alt=""></li>
</ul>
<h2 id="3-浏览器请求"><a href="#3-浏览器请求" class="headerlink" title="3 浏览器请求"></a>3 浏览器请求</h2><p>在浏览器端，CORS过程由浏览器自动完成，在脚本上不需要针对跨域ajax进行额外开发，也无法感知浏览器的预处理过程。</p>
<h3 id="3-1-浏览器支持情况"><a href="#3-1-浏览器支持情况" class="headerlink" title="3.1 浏览器支持情况"></a>3.1 浏览器支持情况</h3><p>目前浏览器对CORS的支持情况如图：<br><img src="http://static.chiyuanyuan.com/13Gfsc.jpg" alt=""><br>其中IE8、9需要通过 XDomainRequest 实现。</p>
<h3 id="3-2-简单请求-非简单请求"><a href="#3-2-简单请求-非简单请求" class="headerlink" title="3.2 简单请求/非简单请求"></a>3.2 简单请求/非简单请求</h3><p>前面提到，当浏览器发现请求跨域，会自动进行预处理。在这个过程中，浏览器将跨域请求分为：</p>
<ul>
<li>简单请求</li>
<li>非简单请求</li>
</ul>
<p>仅当请求满足下面条件，才会被认为是简单请求，否则是非简单请求：</p>
<ul>
<li>请求方法为以下三种之一<ul>
<li>GET</li>
<li>POST</li>
<li>HEAD</li>
</ul>
</li>
<li>请求HTTP头仅包含以下字段<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Last-Event-ID</li>
<li>Content-Type：application/x-www-form-urlencoded、multipart/form-data、text/plain</li>
</ul>
</li>
</ul>
<p>针对两种不同的请求，浏览器会选择不同的预处理方式。</p>
<h2 id="4-简单请求流程"><a href="#4-简单请求流程" class="headerlink" title="4 简单请求流程"></a>4 简单请求流程</h2><h3 id="4-1-流程概览"><a href="#4-1-流程概览" class="headerlink" title="4.1 流程概览"></a>4.1 流程概览</h3><p><img src="http://static.chiyuanyuan.com/fFJB5n.jpg" alt=""></p>
<h3 id="4-2-浏览器添加Origin头"><a href="#4-2-浏览器添加Origin头" class="headerlink" title="4.2 浏览器添加Origin头"></a>4.2 浏览器添加Origin头</h3><p>对于简单请求，浏览器自动为请求头补充Origin字段。<br>这个字段要标明请求方的源信息，包括：域名、协议、端口，以供服务器判断是否许可本次跨域请求，例如：<br><img src="http://static.chiyuanyuan.com/jXDFOa.jpg" alt=""></p>
<h3 id="4-3-请求返回"><a href="#4-3-请求返回" class="headerlink" title="4.3 请求返回"></a>4.3 请求返回</h3><p>不论服务器是否许可，本次请求均会正常返回到浏览器。<br>不同点在于：只有请求被许可，返回头才会包含Access-Control-Allow-Origin。<br>除此之外，被许可的跨域请求返回头可能多出其他字段。还是上面那次请求，返回头如下：<br><img src="http://static.chiyuanyuan.com/cvZpiB.jpg" alt=""></p>
<p>三个头字段的解释：</p>
<ul>
<li>Access-Control-Allow-Origin：必须。值为请求头Origin或 * </li>
<li>Access-Control-Expose-Headers：可选。正常情况下，跨域返回只能拿到Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma六个头，如需额外头，在这里指定。</li>
<li>Access-Control-Allow-Credentials：可选。是否允许请求携带cookie（后面会说）。</li>
</ul>
<h3 id="4-4-浏览器判断"><a href="#4-4-浏览器判断" class="headerlink" title="4.4 浏览器判断"></a>4.4 浏览器判断</h3><p>当请求不被许可，即返回头缺失Access-Control-Allow-Origin字段，浏览器终止跨域请求并报错：</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">load</span> https://b.baidu.com: <span class="hljs-keyword">No</span> <span class="hljs-string">'Access-Control-Allow-Origin'</span> <span class="hljs-keyword">header</span> <span class="hljs-keyword">is</span> present <span class="hljs-keyword">on</span> the requested resource. Origin <span class="hljs-string">'https://a.baidu.com'</span> <span class="hljs-keyword">is</span> therefore <span class="hljs-keyword">not</span> allowed <span class="hljs-keyword">access</span>.<br>// 返回头没有<span class="hljs-keyword">Access</span>-Control-Allow-Origin<br></code></pre></td></tr></table></figure>

<h2 id="5-非简单请求流程"><a href="#5-非简单请求流程" class="headerlink" title="5 非简单请求流程"></a>5 非简单请求流程</h2><h3 id="5-1-流程概览"><a href="#5-1-流程概览" class="headerlink" title="5.1 流程概览"></a>5.1 流程概览</h3><p><img src="http://static.chiyuanyuan.com/64DCD5.jpg" alt=""></p>
<h3 id="5-2-预检请求"><a href="#5-2-预检请求" class="headerlink" title="5.2 预检请求"></a>5.2 预检请求</h3><p>当浏览器检测到非简单请求，会首先发送预检请求。<br>例如：在一次文件上传请求中，上传接口被调用两次，第一次即为预检请求：<br><img src="http://static.chiyuanyuan.com/5PxjhS.jpg" alt=""><br>预检请求使用OPTIONS方法：<br><img src="http://static.chiyuanyuan.com/wD1twJ.jpg" alt=""><br>一次预检请求的请求头如下：<br><img src="http://static.chiyuanyuan.com/14fAfQ.jpg" alt=""><br>头部携带三个相关字段：</p>
<ul>
<li>Origin：必须。</li>
<li>Access-Control-Request-Method：必须。正式请求的请求方法。</li>
<li>Access-Control-Request-Headers：可选（例子中被省略）。正式请求额外发送的头字段。</li>
</ul>
<h3 id="5-3-预检请求返回"><a href="#5-3-预检请求返回" class="headerlink" title="5.3 预检请求返回"></a>5.3 预检请求返回</h3><p>服务器进行预检请求处理，根据三个头部字段，决定是否许可本次跨域请求。<br>预检请求的返回头如下：<br><img src="http://static.chiyuanyuan.com/FxoVMt.jpg" alt=""><br>对于许可的请求，服务器返回头携带五个相关字段：</p>
<ul>
<li>Access-Control-Allow-Origin：必须。同简单请求。</li>
<li>Access-Control-Allow-Methods：必须。许可的请求方法，这里不是只列出请求头中的方法，而是列出所有支持的方法，可以减少预检请求次数。</li>
<li>Access-Control-Allow-Headers：可选。同简单请求。</li>
<li>Access-Control-Allow-Credentials：可选。同简单请求。</li>
<li>Access-Control-Max-Age：可选。预检结果有效期，单位为s。</li>
</ul>
<h3 id="5-4-正式请求"><a href="#5-4-正式请求" class="headerlink" title="5.4 正式请求"></a>5.4 正式请求</h3><p>当预检请求通过，浏览器才正式发送本次跨域请求，发送方式和返回同简单请求。</p>
<h3 id="5-5-PHP中配置header"><a href="#5-5-PHP中配置header" class="headerlink" title="5.5 PHP中配置header"></a>5.5 PHP中配置header</h3><p>PreUpload.php<br><img src="http://static.chiyuanyuan.com/HUOTid.jpg" alt=""></p>
<h2 id="6-携带cookie"><a href="#6-携带cookie" class="headerlink" title="6 携带cookie"></a>6 携带cookie</h2><p>CORS默认是不携带cookie的。如果想携带cookie，需要浏览器端脚本和服务器端都做处理。</p>
<h3 id="6-1-浏览器端处理"><a href="#6-1-浏览器端处理" class="headerlink" title="6.1 浏览器端处理"></a>6.1 浏览器端处理</h3><p>在浏览器端，需要为ajax请求添加携带cookie标识。<br>几种实现中添加方法如下：<br>原生</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-type">XMLHttpRequest</span>();<br>xhr.withCredentials = <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure>

<p>jQuery</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">$.ajax(&#123;</span><br>    <span class="hljs-string">……</span><br>    <span class="hljs-attr">xhrFields:</span> <span class="hljs-string">&#123;</span><br>        <span class="hljs-attr">withCredentials:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-string">&#125;,</span><br><span class="hljs-string">……</span><br></code></pre></td></tr></table></figure>

<p>fetch</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><code class="hljs dts">fetch(……, &#123;<br>    ……<br><span class="hljs-symbol">    credentials:</span> <span class="hljs-string">"include"</span><br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="6-2-服务器端处理"><a href="#6-2-服务器端处理" class="headerlink" title="6.2 服务器端处理"></a>6.2 服务器端处理</h3><p>服务器端也需要添加允许传cookie的头，就是前面说的：</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">Access</span>-Control-Allow-Credentials：<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

















  </div>
</section>

  




    </div>
  </div>
</body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script src="/js/script.js"></script>

</html>